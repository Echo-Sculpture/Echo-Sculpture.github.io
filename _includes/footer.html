{% if site.author.github or site.author.bitbucket or site.atom_feed.hide != true %}
<div class="page__footer-follow">
  <ul class="social-icons">
    {% if site.author.github %}
      <li><a href="https://github.com/{{ site.author.github }}"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    {% endif %}
    <li><a href="{{ base_path }}/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>
{% endif %}

<div class="page__footer-copyright">
  &copy; {{ site.time | date: '%Y' }} {{ site.name | default: site.title }}.
</div>

<style>
  html, body, #main, .wrapper, .page__inner-wrap { background-color: transparent !important; }
  .page__inner-wrap {
    background-color: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(5px);
    z-index: 1;
    position: relative;
  }
  #p5-background {
    position: fixed !important;
    top: 0; left: 0;
    z-index: -1 !important;
    pointer-events: none;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>

{% raw %}
<script>
// 将所有 Class 放入 raw 标签中，防止 Jekyll 解析错误
class Rectangle {
  constructor(x, y, width, height) {
    this.x = x; this.y = y; this.width = width; this.height = height;
  }
  getBottom() { return this.y + this.height; }
}

class Spectrogram extends Rectangle {
  constructor(x, y, width, height, lengthInSeconds) {
    super(x, y, width, height);
    this.samplingRate = sampleRate();
    this.lengthInSeconds = lengthInSeconds;
    this.bufferIndex = 0;
    
    // 你的双缓冲逻辑
    this.gfx1 = createGraphics(this.width, this.height);
    this.gfx2 = createGraphics(this.width, this.height);
    this.gfx1.x = 0;
    this.gfx2.x = this.width;
  }

  update(spectrum) {
    let totalSamples = this.lengthInSeconds * this.samplingRate;
    let xBufferVal = map(this.bufferIndex, 0, totalSamples, 0, this.width);
    let xVal = xBufferVal % this.width;
    let selectIdx = floor(xBufferVal / this.width) % 2;
    
    let activeGfx = (selectIdx === 0) ? this.gfx1 : this.gfx2;

    if (selectIdx === 0) {
      this.gfx1.x = -xVal;
      this.gfx2.x = this.width - xVal;
    } else {
      this.gfx1.x = this.width - xVal;
      this.gfx2.x = -xVal;
    }

    activeGfx.push();
    activeGfx.strokeWeight(2);
    for (let i = 0; i < spectrum.length; i += 8) {
      let y = map(i, 0, spectrum.length, this.height, 0);
      let amp = spectrum[i];
      if (amp > 50) {
        let hue = map(i, 0, spectrum.length, 180, 260);
        activeGfx.stroke(hue, 80, 90, map(amp, 0, 255, 0, 100));
        activeGfx.line(xVal, y, xVal + 2, y);
      }
    }
    activeGfx.pop();
    this.bufferIndex += spectrum.length;
  }

  draw() {
    image(this.gfx1, this.gfx1.x, this.y);
    image(this.gfx2, this.gfx2.x, this.y);
  }
}

let mic, fft, visualizer;
let isReady = false;

function setup() {
  let cnv = createCanvas(windowWidth, windowHeight);
  cnv.id('p5-background');
  cnv.parent(document.body);
  colorMode(HSB, 360, 100, 100, 100);
  fft = new p5.FFT(0.8, 512);
}

function draw() {
  clear();
  if (!isReady) {
    fill(150);
    textAlign(CENTER);
    text("CLICK ANYWHERE TO ACTIVATE MIC", width/2, height/2);
    return;
  }

  let spectrum = fft.analyze();
  if (visualizer) {
    visualizer.update(spectrum);
    visualizer.draw();
  }
}

// 必须点击页面才能启动音频
function mousePressed() {
  if (!isReady) {
    userStartAudio().then(() => {
      mic = new p5.AudioIn();
      mic.start();
      fft.setInput(mic);
      // 这里的 sampleRate() 现在有效了
      visualizer = new Spectrogram(0, 0, width, height, 10);
      isReady = true;
      console.log("Audio System Started");
    });
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
{% endraw %}
