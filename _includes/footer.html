{% if site.author.github or site.author.bitbucket or site.atom_feed.hide != true %}
<div class="page__footer-follow">
  <ul class="social-icons">
    {% if site.author.github %}
      <li><a href="https://github.com/{{ site.author.github }}"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    {% endif %}
    <li><a href="{% if site.atom_feed.path %}{{ site.atom_feed.path }}{% else %}{{ base_path }}/feed.xml{% endif %}"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>
{% endif %}

<div class="page__footer-copyright">
  &copy; {{ site.time | date: '%Y' }} {{ site.name | default: site.title }}. Site last updated {{ "now" | date: '%Y-%m-%d' }}
</div>

<style>
  /* === 1. 深度拆墙 CSS (保持不变) === */
  html, body, #main, .initial-content, .page, .page__inner-wrap,
  .page__content, .page__footer, .masthead, .greedy-nav, .sidebar, .archive,
  #main-content, #main-wrapper, .wrapper {
    background-color: transparent !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* === 2. 文字区域磨砂玻璃效果 === */
  .page__inner-wrap {
    background-color: rgba(255, 255, 255, 0.8) !important; 
    padding: 30px !important;
    border-radius: 15px !important;
    backdrop-filter: blur(5px);
    z-index: 1;
  }

  /* === 3. p5.js 画布全屏置底 === */
  #p5-background {
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw !important; height: 100vh !important;
    z-index: -1 !important;
    pointer-events: auto; /* 允许点击背景来激活音频 */
  }
</style>

{% raw %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>

<script>
  let mic, fft;
  let cols, rows;
  let resolution = 30; // 调整方块大小
  let grid = []; 
  let isAudioStarted = false;

  function setup() {
    let cnv = createCanvas(windowWidth, windowHeight);
    cnv.id('p5-background');
    cnv.parent(document.body);
    
    // 初始化 FFT，但先不急着 start mic，等点击
    fft = new p5.FFT(0.7, 512);
    
    colorMode(HSB, 360, 100, 100, 100);
    calculateGrid();
  }

  function calculateGrid() {
    cols = ceil(width / resolution) + 1;
    rows = ceil(height / resolution) + 1;
    grid = [];
    for (let i = 0; i < cols; i++) {
      grid[i] = new Float32Array(rows).fill(0);
    }
  }

  function draw() {
    clear(); // 清空画布

    // --- 1. 获取音频数据 ---
    let spectrum;
    if (isAudioStarted) {
      spectrum = fft.analyze();
    } else {
      // 如果没开启，就传个空数组，防止报错
      spectrum = new Array(512).fill(0);
    }

    // --- 2. 滚动逻辑 ---
    grid.shift(); 
    let newCol = new Float32Array(rows);
    
    // 只有音频开启时才计算新数据
    if (isAudioStarted) {
      let usableSpectrumSize = spectrum.length * 0.8; 
      for (let y = 0; y < rows; y++) {
        let mapIndex = floor(map(rows - y, 0, rows, 0, usableSpectrumSize));
        newCol[y] = spectrum[mapIndex];
      }
    }
    grid.push(newCol);

    // --- 3. 渲染网格 ---
    noStroke();
    
    for (let x = 0; x < cols; x++) {
      for (let y = 0; y < rows; y++) {
        let amp = grid[x][y];
        
        let xPos = x * resolution;
        let yPos = y * resolution;
        
        if (amp > 20) { 
          // [有声音] 激活状态：多彩方块
          let h = map(y, 0, rows, 160, 260); // 上青下紫
          let s = map(amp, 0, 255, 60, 100);
          let b = map(amp, 0, 255, 80, 100);
          let alpha = map(amp, 0, 255, 40, 100);
          
          fill(h, s, b, alpha);
          let sizeMod = map(amp, 0, 255, 0.6, 0.9);
          rect(xPos, yPos, resolution * sizeMod, resolution * sizeMod, 3);
          
        } else {
          // [无声音] 静默状态：绘制极淡的灰色网格
          // 这样你就知道程序还在跑，不是坏了
          fill(200, 5, 80, 5); // 极淡的颜色
          rect(xPos, yPos, resolution * 0.2, resolution * 0.2, 1);
        }
      }
    }

    // --- 4. 提示文字 ---
    if (!isAudioStarted) {
      fill(0); 
      textAlign(CENTER);
      textSize(20);
      text("CLICK ANYWHERE TO START AUDIO", width/2, height/2);
    }
  }

  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
    calculateGrid();
  }

  // --- 关键：点击屏幕任何地方激活麦克风 ---
  function mousePressed() {
    startAudioContext();
  }
  
  function touchStarted() {
    startAudioContext();
  }

  function startAudioContext() {
    if (!isAudioStarted) {
      userStartAudio(); // p5.sound 的标准启动函数
      
      mic = new p5.AudioIn();
      mic.start();
      fft.setInput(mic);
      
      isAudioStarted = true;
      console.log("Audio Context Started");
    }
  }
</script>
{% endraw %}
