{% if site.author.github or site.author.bitbucket or site.atom_feed.hide != true %}
<div class="page__footer-follow">
  <ul class="social-icons">
    {% if site.author.github %}
      <li><a href="https://github.com/{{ site.author.github }}"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    {% endif %}
    <li><a href="{% if site.atom_feed.path %}{{ site.atom_feed.path }}{% else %}{{ base_path }}/feed.xml{% endif %}"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>
{% endif %}

<div class="page__footer-copyright">
  &copy; {{ site.time | date: '%Y' }} {{ site.name | default: site.title }}.
</div>

<style>
  /* 暴力调试 CSS */
  #p5-background {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    /* 暂时设为最高层级，确保它浮在所有内容表面 */
    z-index: 9999 !important; 
    pointer-events: none;
  }
</style>

{% raw %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>

<script>
  let mic, fft;
  let cols, rows;
  let resolution = 40; 
  let grid = []; 
  let isAudioStarted = false;

  function setup() {
    let cnv = createCanvas(windowWidth, windowHeight);
    cnv.id('p5-background');
    cnv.parent(document.body);
    
    // 初始化 FFT
    fft = new p5.FFT(0.8, 512);
    
    colorMode(HSB, 360, 100, 100, 100);
    calculateGrid();
    
    console.log("P5 Setup Complete - Canvas Created");
  }

  function calculateGrid() {
    cols = ceil(width / resolution) + 1;
    rows = ceil(height / resolution) + 1;
    grid = [];
    for (let i = 0; i < cols; i++) {
      grid[i] = new Float32Array(rows).fill(0);
    }
  }

  function draw() {
    // 【关键调试点】不再使用 clear()，使用半透明黑色背景，制造拖影
    background(0, 0, 10, 20); // 如果你看到屏幕变黑，说明 p5 在运行！

    // --- 1. 获取数据 (混合了假数据，确保一定有东西动) ---
    let spectrum;
    if (isAudioStarted) {
      spectrum = fft.analyze();
    } else {
      spectrum = new Array(512).fill(0);
    }

    // --- 2. 滚动逻辑 ---
    grid.shift(); 
    let newCol = new Float32Array(rows);
    
    // 模拟数据生成：如果没有音频，我们用 noise 生成波浪，证明渲染没问题
    let time = millis() * 0.002;
    
    for (let y = 0; y < rows; y++) {
      let val = 0;
      if (isAudioStarted) {
        let usableSpectrumSize = spectrum.length * 0.8; 
        let mapIndex = floor(map(rows - y, 0, rows, 0, usableSpectrumSize));
        val = spectrum[mapIndex];
      } else {
        // 生成假数据可视化
        let noiseVal = noise(y * 0.1, time);
        if (noiseVal > 0.4) {
            val = map(noiseVal, 0.4, 1, 0, 200);
        }
      }
      newCol[y] = val;
    }
    grid.push(newCol);

    // --- 3. 渲染 ---
    noStroke();
    for (let x = 0; x < cols; x++) {
      for (let y = 0; y < rows; y++) {
        let amp = grid[x][y];
        
        // 只要有数值就画
        if (amp > 10) { 
          let h = map(y, 0, rows, 160, 260); 
          fill(h, 80, 100, 80);
          rect(x * resolution, y * resolution, resolution * 0.8, resolution * 0.8);
        } else {
            // 调试点：画出非常明显的空闲网格（深灰色）
            fill(0, 0, 30, 50); 
            rect(x * resolution + 5, y * resolution + 5, 5, 5);
        }
      }
    }

    // --- 4. 调试文字 ---
    fill(0, 0, 100);
    textSize(20);
    textAlign(LEFT, TOP);
    text("DEBUG MODE: " + (isAudioStarted ? "MIC ON" : "MIC OFF (CLICK SCREEN)"), 20, 20);
    
    // 画一个旋转的红球，证明 draw() 每一帧都在跑
    fill(0, 100, 100);
    ellipse(mouseX, mouseY, 20, 20);
  }

  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
    calculateGrid();
  }

  function mousePressed() {
    startAudioContext();
  }
  
  function touchStarted() {
    startAudioContext();
  }

  function startAudioContext() {
    if (!isAudioStarted) {
      userStartAudio();
      mic = new p5.AudioIn();
      mic.start();
      fft.setInput(mic);
      isAudioStarted = true;
    }
  }
</script>
{% endraw %}
