{% if site.author.github or site.author.bitbucket or site.atom_feed.hide != true %}
<div class="page__footer-follow">
  <ul class="social-icons">
    {% if site.author.github %}
      <li><a href="https://github.com/{{ site.author.github }}"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    {% endif %}
    <li><a href="{{ base_path }}/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>
{% endif %}

<div class="page__footer-copyright">
  &copy; {{ site.time | date: '%Y' }} {{ site.name | default: site.title }}.
</div>

<style>
  /* 1. 终极背景爆破：解决白板问题 */
  /* 我们不仅设为透明，还要强制取消所有背景图片和阴影 */
  html, body, #main, .initial-content, .page, .masthead, .page__footer, 
  .page__inner-wrap, .archive, .wrapper, #main-wrapper {
    background: none !important;
    background-color: transparent !important;
    box-shadow: none !important;
  }

  /* 2. 内容区磨砂玻璃（可选，为了看清文字） */
  .page__inner-wrap {
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10;
    position: relative;
  }

  /* 3. 画布层级调整 */
  #p5-background {
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw !important;
    height: 100vh !important;
    z-index: -1 !important; /* 置于底层 */
    pointer-events: all !important; /* 必须允许点击，否则无法激活麦克风 */
    display: block !important;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>

{% raw %}
<script>
class Rectangle {
  constructor(x, y, w, h) { this.x = x; this.y = y; this.w = w; this.h = h; }
  getBottom() { return this.y + this.h; }
}

class Spectrogram extends Rectangle {
  constructor(x, y, w, h, lenSec) {
    super(x, y, w, h);
    this.samplingRate = sampleRate() || 44100;
    this.lenSec = lenSec;
    this.bufferIndex = 0;
    this.gfx1 = createGraphics(w, h);
    this.gfx2 = createGraphics(w, h);
    this.gfx1.x = 0;
    this.gfx2.x = w;
  }

  update(spectrum) {
    let xBufVal = map(this.bufferIndex, 0, this.lenSec * this.samplingRate, 0, this.w);
    let xVal = xBufVal % this.w;
    let select = floor(xBufVal / this.w) % 2;
    let active = (select === 0) ? this.gfx1 : this.gfx2;

    if (select === 0) { this.gfx1.x = -xVal; this.gfx2.x = this.w - xVal; }
    else { this.gfx1.x = this.w - xVal; this.gfx2.x = -xVal; }

    active.noStroke();
    for (let i = 0; i < spectrum.length; i += 6) {
      let y = map(i, 0, spectrum.length, this.h, 0);
      let amp = spectrum[i];
      if (amp > 30) {
        let hue = map(i, 0, spectrum.length, 190, 280);
        active.fill(hue, 80, 100, map(amp, 0, 255, 0, 100));
        active.rect(xVal, y, 2, 4);
      }
    }
    this.bufferIndex += spectrum.length;
  }

  draw() {
    image(this.gfx1, this.gfx1.x, this.y);
    image(this.gfx2, this.gfx2.x, this.y);
  }
}

let mic, fft, visualizer;
let active = false;

function setup() {
  let cnv = createCanvas(windowWidth, windowHeight);
  cnv.id('p5-background');
  cnv.parent(document.body);
  colorMode(HSB, 360, 100, 100, 100);
  fft = new p5.FFT(0.8, 512);
  background(0); // 初始黑色背景
}

function draw() {
  // 如果成功透视，你会看到背景变黑或变深。
  if (!active) {
    background(10); // 没启动时显示深灰色
    fill(255);
    textAlign(CENTER);
    textSize(20);
    text("TAP SCREEN TO ENABLE MIC", width/2, height/2);
    return;
  }
  
  clear(); // 运行中保持透明
  let spectrum = fft.analyze();
  if (visualizer) {
    visualizer.update(spectrum);
    visualizer.draw();
  }
}

function mousePressed() {
  if (!active) {
    // 诊断弹窗：如果点击生效，一定会弹出这个
    console.log("Mouse Pressed - Attempting to start audio");
    
    userStartAudio().then(() => {
      mic = new p5.AudioIn();
      mic.start(function() {
          console.log("Mic started successfully");
          visualizer = new Spectrogram(0, 0, width, height, 15);
          active = true;
      }, function(e) {
          alert("Microphone Error: " + e);
      });
    }).catch(err => {
      alert("Audio Context Error: " + err);
    });
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
{% endraw %}
